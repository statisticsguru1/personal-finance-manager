uuid <- load_user_file("user123", "account_tree.Rds")$uuid
print(uuid)
# âœ… Server wait helper
wait_for_server_ready <- function(
url = "http://127.0.0.1:8000/__ping__",
timeout = 40
) {
start_time <- Sys.time()
while (as.numeric(Sys.time() - start_time, units = "secs") < timeout) {
res <- tryCatch(httr::GET(url), error = function(e) NULL)
if (!is.null(res) && httr::status_code(res) == 200) return(TRUE)
Sys.sleep(0.25)
}
stop("Server did not become ready within timeout.")
}
# ğŸ”§ Run main.R via callr
server <- callr::r_bg(
function(main_file, jwt, base_dir) {
Sys.setenv(JWT_SECRET = jwt)
Sys.setenv(ACCOUNT_BASE_DIR = base_dir)
Sys.setenv(ACCOUNT_BACKEND = "file")
source(main_file)
},
args = list(
main_file = here("api", "main.R"),
jwt = secret_key,
base_dir = tmp_dir
),
stdout = "|", stderr = "|"
)
withr::defer(server$kill(), envir = globalenv())
wait_for_server_ready()
cat("Server output:\n")
cat(server$read_output_lines(), sep = "\n")
cat("Server errors:\n")
cat(server$read_error_lines(), sep = "\n")
# ğŸª™ Make the deposit
valid_token <- jwt_encode_hmac(
jwt_claim(user_id = "user123", role = "user"),
secret = secret_key
)
res <- POST(
url = "http://127.0.0.1:8000/deposit",
add_headers(Authorization = paste("Bearer", valid_token)),
body = list(
uuid = uuid,
amount = 1000,
channel = "bank"
),
encode = "form"
)
cat("Status Code:", status_code(res), "\n")
print(content(res))
library(testthat)
library(httr)
library(jose)
library(withr)
library(here)
library(callr)
#devtools::install()
Sys.setenv(JWT_SECRET = "test-secret")
secret_key <- Sys.getenv("JWT_SECRET")
#tmp_dir <- local_tempdir()
tmp_dir <- tempfile("test-account-base-")
dir.create(tmp_dir, recursive = TRUE)
Sys.setenv(ACCOUNT_BASE_DIR = tmp_dir)
Sys.setenv(ACCOUNT_BACKEND = "file")
# Create test user
create_user_account_base(
user_id = "user123",
base_dir = tmp_dir,
initial_balance = 1000
)
uuid <- load_user_file("user123", "account_tree.Rds")$uuid
print(uuid)
# âœ… Server wait helper
wait_for_server_ready <- function(
url = "http://127.0.0.1:8000/__ping__",
timeout = 40
) {
start_time <- Sys.time()
while (as.numeric(Sys.time() - start_time, units = "secs") < timeout) {
res <- tryCatch(httr::GET(url), error = function(e) NULL)
if (!is.null(res) && httr::status_code(res) == 200) return(TRUE)
Sys.sleep(0.25)
}
stop("Server did not become ready within timeout.")
}
# ğŸ”§ Run main.R via callr
server <- callr::r_bg(
function(main_file, jwt, base_dir) {
Sys.setenv(JWT_SECRET = jwt)
Sys.setenv(ACCOUNT_BASE_DIR = base_dir)
Sys.setenv(ACCOUNT_BACKEND = "file")
source(main_file)
},
args = list(
main_file = here("api", "main.R"),
jwt = secret_key,
base_dir = tmp_dir
),
stdout = "|", stderr = "|"
)
withr::defer(server$kill(), envir = globalenv())
wait_for_server_ready()
cat("Server output:\n")
cat(server$read_output_lines(), sep = "\n")
cat("Server errors:\n")
cat(server$read_error_lines(), sep = "\n")
# ğŸª™ Make the deposit
valid_token <- jwt_encode_hmac(
jwt_claim(user_id = "user123", role = "user"),
secret = secret_key
)
res <- POST(
url = "http://127.0.0.1:8000/deposit",
add_headers(Authorization = paste("Bearer", valid_token)),
body = list(
uuid = uuid,
amount = 1000,
channel = "bank"
),
encode = "form"
)
cat("Status Code:", status_code(res), "\n")
print(content(res))
library(testthat)
library(httr)
library(jose)
library(withr)
library(here)
library(callr)
#devtools::install()
Sys.setenv(JWT_SECRET = "test-secret")
secret_key <- Sys.getenv("JWT_SECRET")
#tmp_dir <- local_tempdir()
tmp_dir <- tempfile("test-account-base-")
dir.create(tmp_dir, recursive = TRUE)
Sys.setenv(ACCOUNT_BASE_DIR = tmp_dir)
Sys.setenv(ACCOUNT_BACKEND = "file")
# Create test user
create_user_account_base(
user_id = "user123",
base_dir = tmp_dir,
initial_balance = 1000
)
?finman::create_user_account_base()
?finman::ChildAccount
library(testthat)
library(httr)
library(jose)
library(withr)
library(here)
library(callr)
library(finman)
#devtools::install()
Sys.setenv(JWT_SECRET = "test-secret")
secret_key <- Sys.getenv("JWT_SECRET")
#tmp_dir <- local_tempdir()
tmp_dir <- tempfile("test-account-base-")
dir.create(tmp_dir, recursive = TRUE)
Sys.setenv(ACCOUNT_BASE_DIR = tmp_dir)
Sys.setenv(ACCOUNT_BACKEND = "file")
# Create test user
create_user_account_base(
user_id = "user123",
base_dir = tmp_dir,
initial_balance = 1000
)
uuid <- load_user_file("user123", "account_tree.Rds")$uuid
print(uuid)
# âœ… Server wait helper
wait_for_server_ready <- function(
url = "http://127.0.0.1:8000/__ping__",
timeout = 40
) {
start_time <- Sys.time()
while (as.numeric(Sys.time() - start_time, units = "secs") < timeout) {
res <- tryCatch(httr::GET(url), error = function(e) NULL)
if (!is.null(res) && httr::status_code(res) == 200) return(TRUE)
Sys.sleep(0.25)
}
stop("Server did not become ready within timeout.")
}
# ğŸ”§ Run main.R via callr
server <- callr::r_bg(
function(main_file, jwt, base_dir) {
Sys.setenv(JWT_SECRET = jwt)
Sys.setenv(ACCOUNT_BASE_DIR = base_dir)
Sys.setenv(ACCOUNT_BACKEND = "file")
source(main_file)
},
args = list(
main_file = here("api", "main.R"),
jwt = secret_key,
base_dir = tmp_dir
),
stdout = "|", stderr = "|"
)
withr::defer(server$kill(), envir = globalenv())
wait_for_server_ready()
cat("Server output:\n")
cat(server$read_output_lines(), sep = "\n")
cat("Server errors:\n")
cat(server$read_error_lines(), sep = "\n")
# ğŸª™ Make the deposit
valid_token <- jwt_encode_hmac(
jwt_claim(user_id = "user123", role = "user"),
secret = secret_key
)
res <- POST(
url = "http://127.0.0.1:8000/deposit",
add_headers(Authorization = paste("Bearer", valid_token)),
body = list(
uuid = uuid,
amount = 1000,
channel = "bank"
),
encode = "form"
)
cat("Status Code:", status_code(res), "\n")
print(content(res))
res2 <- POST(
url = "http://127.0.0.1:8000/deposit",
add_headers(Authorization = paste("Bearer", valid_token)),
body = list(
uuid = uuid,
amount = 2000,
channel = "bank"
),
encode = "form"
)
cat("Status Code:", status_code(res2), "\n")
print(content(res2))
library(testthat)
library(httr)
library(jose)
library(withr)
library(here)
library(callr)
library(finman)
#devtools::install()
Sys.setenv(JWT_SECRET = "test-secret")
secret_key <- Sys.getenv("JWT_SECRET")
#tmp_dir <- local_tempdir()
tmp_dir <- tempfile("test-account-base-")
dir.create(tmp_dir, recursive = TRUE)
Sys.setenv(ACCOUNT_BASE_DIR = tmp_dir)
Sys.setenv(ACCOUNT_BACKEND = "file")
# Create test user
create_user_account_base(
user_id = "user123",
base_dir = tmp_dir,
initial_balance = 1000
)
uuid <- load_user_file("user123", "account_tree.Rds")$uuid
print(uuid)
# âœ… Server wait helper
wait_for_server_ready <- function(
url = "http://127.0.0.1:8000/__ping__",
timeout = 40
) {
start_time <- Sys.time()
while (as.numeric(Sys.time() - start_time, units = "secs") < timeout) {
res <- tryCatch(httr::GET(url), error = function(e) NULL)
if (!is.null(res) && httr::status_code(res) == 200) return(TRUE)
Sys.sleep(0.25)
}
stop("Server did not become ready within timeout.")
}
# ğŸ”§ Run main.R via callr
server <- callr::r_bg(
function(main_file, jwt, base_dir) {
Sys.setenv(JWT_SECRET = jwt)
Sys.setenv(ACCOUNT_BASE_DIR = base_dir)
Sys.setenv(ACCOUNT_BACKEND = "file")
source(main_file)
},
args = list(
main_file = here("api", "main.R"),
jwt = secret_key,
base_dir = tmp_dir
),
stdout = "|", stderr = "|"
)
withr::defer(server$kill(), envir = globalenv())
wait_for_server_ready()
cat("Server output:\n")
cat(server$read_output_lines(), sep = "\n")
cat("Server errors:\n")
cat(server$read_error_lines(), sep = "\n")
# ğŸª™ Make the deposit
valid_token <- jwt_encode_hmac(
jwt_claim(user_id = "user123", role = "user"),
secret = secret_key
)
res <- POST(
url = "http://127.0.0.1:8000/deposit",
add_headers(Authorization = paste("Bearer", valid_token)),
body = list(
uuid = uuid,
amount = 1000,
channel = "bank"
),
encode = "form"
)
cat("Status Code:", status_code(res), "\n")
print(content(res))
res2 <- POST(
url = "http://127.0.0.1:8000/deposit",
add_headers(Authorization = paste("Bearer", valid_token)),
body = list(
uuid = uuid,
amount = 2000,
channel = "bank"
),
encode = "form"
)
cat("Status Code:", status_code(res2), "\n")
print(content(res2))
library(testthat)
library(httr)
library(jose)
library(withr)
library(here)
library(callr)
library(finman)
#devtools::install()
Sys.setenv(JWT_SECRET = "test-secret")
secret_key <- Sys.getenv("JWT_SECRET")
#tmp_dir <- local_tempdir()
tmp_dir <- tempfile("test-account-base-")
dir.create(tmp_dir, recursive = TRUE)
Sys.setenv(ACCOUNT_BASE_DIR = tmp_dir)
Sys.setenv(ACCOUNT_BACKEND = "file")
# Create test user
create_user_account_base(
user_id = "user123",
base_dir = tmp_dir,
initial_balance = 1000
)
uuid <- load_user_file("user123", "account_tree.Rds")$uuid
print(uuid)
# âœ… Server wait helper
wait_for_server_ready <- function(
url = "http://127.0.0.1:8000/__ping__",
timeout = 40
) {
start_time <- Sys.time()
while (as.numeric(Sys.time() - start_time, units = "secs") < timeout) {
res <- tryCatch(httr::GET(url), error = function(e) NULL)
if (!is.null(res) && httr::status_code(res) == 200) return(TRUE)
Sys.sleep(0.25)
}
stop("Server did not become ready within timeout.")
}
# ğŸ”§ Run main.R via callr
server <- callr::r_bg(
function(main_file, jwt, base_dir) {
Sys.setenv(JWT_SECRET = jwt)
Sys.setenv(ACCOUNT_BASE_DIR = base_dir)
Sys.setenv(ACCOUNT_BACKEND = "file")
source(main_file)
},
args = list(
main_file = here("api", "main.R"),
jwt = secret_key,
base_dir = tmp_dir
),
stdout = "|", stderr = "|"
)
withr::defer(server$kill(), envir = globalenv())
wait_for_server_ready()
cat("Server output:\n")
cat(server$read_output_lines(), sep = "\n")
cat("Server errors:\n")
cat(server$read_error_lines(), sep = "\n")
# ğŸª™ Make the deposit
valid_token <- jwt_encode_hmac(
jwt_claim(user_id = "user123", role = "user"),
secret = secret_key
)
res <- POST(
url = "http://127.0.0.1:8000/deposit",
add_headers(Authorization = paste("Bearer", valid_token)),
body = list(
uuid = uuid,
amount = 1000,
channel = "bank"
),
encode = "form"
)
cat("Status Code:", status_code(res), "\n")
print(content(res))
res2 <- POST(
url = "http://127.0.0.1:8000/deposit",
add_headers(Authorization = paste("Bearer", valid_token)),
body = list(
uuid = uuid,
amount = 2000,
channel = "bank"
),
encode = "form"
)
cat("Status Code:", status_code(res2), "\n")
print(content(res2))
library(testthat)
library(httr)
library(jose)
library(withr)
library(here)
library(callr)
library(finman)
#devtools::install()
Sys.setenv(JWT_SECRET = "test-secret")
secret_key <- Sys.getenv("JWT_SECRET")
#tmp_dir <- local_tempdir()
tmp_dir <- tempfile("test-account-base-")
dir.create(tmp_dir, recursive = TRUE)
Sys.setenv(ACCOUNT_BASE_DIR = tmp_dir)
Sys.setenv(ACCOUNT_BACKEND = "file")
# Create test user
create_user_account_base(
user_id = "user123",
base_dir = tmp_dir,
initial_balance = 1000
)
uuid <- load_user_file("user123", "account_tree.Rds")$uuid
print(uuid)
# âœ… Server wait helper
wait_for_server_ready <- function(
url = "http://127.0.0.1:8000/__ping__",
timeout = 40
) {
start_time <- Sys.time()
while (as.numeric(Sys.time() - start_time, units = "secs") < timeout) {
res <- tryCatch(httr::GET(url), error = function(e) NULL)
if (!is.null(res) && httr::status_code(res) == 200) return(TRUE)
Sys.sleep(0.25)
}
stop("Server did not become ready within timeout.")
}
# ğŸ”§ Run main.R via callr
server <- callr::r_bg(
function(main_file, jwt, base_dir) {
Sys.setenv(JWT_SECRET = jwt)
Sys.setenv(ACCOUNT_BASE_DIR = base_dir)
Sys.setenv(ACCOUNT_BACKEND = "file")
source(main_file)
},
args = list(
main_file = here("api", "main.R"),
jwt = secret_key,
base_dir = tmp_dir
),
stdout = "|", stderr = "|"
)
withr::defer(server$kill(), envir = globalenv())
wait_for_server_ready()
cat("Server output:\n")
cat(server$read_output_lines(), sep = "\n")
cat("Server errors:\n")
cat(server$read_error_lines(), sep = "\n")
# ğŸª™ Make the deposit
valid_token <- jwt_encode_hmac(
jwt_claim(user_id = "user123", role = "user"),
secret = secret_key
)
res <- POST(
url = "http://127.0.0.1:8000/deposit",
add_headers(Authorization = paste("Bearer", valid_token)),
body = list(
uuid = uuid,
amount = 1000,
channel = "bank"
),
encode = "form"
)
cat("Status Code:", status_code(res), "\n")
print(content(res))
res2 <- POST(
url = "http://127.0.0.1:8000/deposit",
add_headers(Authorization = paste("Bearer", valid_token)),
body = list(
uuid = uuid,
amount = 2000,
channel = "bank"
),
encode = "form"
)
cat("Status Code:", status_code(res2), "\n")
print(content(res2))
wait_for_server_ready()
devtools::document()
library(finman)
is.numeric("as")
is.null()
ilai<-MainAccount$new("alab",balance = 1000)
ilai1<-ChildAccount("ilai1")
ilai1<-ChildAccount$new("ilai1")
ilai2<-ChildAccount$new("ilai2")
ilai$add_child_account(ilai1)
ilai$add_child_account(ilai1)
library(tidyverse)
ilai$add_child_account(ilai1)
ilai$add_child_account(ilai2)
ilai$distribute_to_children()
ilai$child_accounts
ilai1$change_status("active")
ilai2$change_status("active")
ilai$distribute_to_children()
devtools::install()
