Sys.setenv(JWT_SECRET = "test-secret")
secret_key <- Sys.getenv("JWT_SECRET")
tmp_dir <- local_tempdir()
Sys.setenv(ACCOUNT_BASE_DIR = tmp_dir)
# Create test user
create_user_account_base(
user_id = "user123",
base_dir = tmp_dir,
initial_balance = 1000
)
uuid <- load_user_account("user123")$uuid
# âœ… Server wait helper
wait_for_server_ready <- function(
url = "http://127.0.0.1:8000/__ping__",
timeout = 10
) {
start_time <- Sys.time()
while (as.numeric(Sys.time() - start_time, units = "secs") < timeout) {
res <- tryCatch(httr::GET(url), error = function(e) NULL)
if (!is.null(res) && httr::status_code(res) == 200) return(TRUE)
Sys.sleep(0.25)
}
stop("Server did not become ready within timeout.")
}
# ðŸ”§ Run main.R via callr
server <- callr::r_bg(
function(main_file, jwt, base_dir) {
Sys.setenv(JWT_SECRET = jwt)
Sys.setenv(ACCOUNT_BASE_DIR = base_dir)
source(main_file)
},
args = list(
main_file = here("api", "main.R"),
jwt = secret_key,
base_dir = tmp_dir
),
stdout = "|", stderr = "|"
)
withr::defer(server$kill(), envir = globalenv())
wait_for_server_ready()
cat("Server output:\n")
cat(readLines(server$read_output_lines(), warn = FALSE), sep = "\n")
library(testthat)
library(httr)
library(jose)
library(withr)
library(here)
library(callr)
devtools::load_all()
Sys.setenv(JWT_SECRET = "test-secret")
secret_key <- Sys.getenv("JWT_SECRET")
tmp_dir <- local_tempdir()
Sys.setenv(ACCOUNT_BASE_DIR = tmp_dir)
# Create test user
create_user_account_base(
user_id = "user123",
base_dir = tmp_dir,
initial_balance = 1000
)
uuid <- load_user_account("user123")$uuid
# âœ… Server wait helper
wait_for_server_ready <- function(
url = "http://127.0.0.1:8000/__ping__",
timeout = 10
) {
start_time <- Sys.time()
while (as.numeric(Sys.time() - start_time, units = "secs") < timeout) {
res <- tryCatch(httr::GET(url), error = function(e) NULL)
if (!is.null(res) && httr::status_code(res) == 200) return(TRUE)
Sys.sleep(0.25)
}
stop("Server did not become ready within timeout.")
}
# ðŸ”§ Run main.R via callr
server <- callr::r_bg(
function(main_file, jwt, base_dir) {
Sys.setenv(JWT_SECRET = jwt)
Sys.setenv(ACCOUNT_BASE_DIR = base_dir)
source(main_file)
},
args = list(
main_file = here("api", "main.R"),
jwt = secret_key,
base_dir = tmp_dir
),
stdout = "|", stderr = "|"
)
withr::defer(server$kill(), envir = globalenv())
wait_for_server_ready()
cat("Server output:\n")
cat(server$read_output_lines(), sep = "\n")
cat("Server errors:\n")
cat(server$read_error_lines(), sep = "\n")
# ðŸª™ Make the deposit
valid_token <- jwt_encode_hmac(
jwt_claim(user_id = "user123", role = "user"),
secret = secret_key
)
res <- POST(
url = "http://127.0.0.1:8000/deposit",
add_headers(Authorization = paste("Bearer", valid_token)),
body = list(
uuid = uuid,
amount = 1000,
channel = "bank"
),
encode = "form"
)
cat("Status Code:", status_code(res), "\n")
print(content(res))
print(list.files(Sys.getenv("ACCOUNT_BASE_DIR"), recursive = TRUE))
library(testthat)
library(httr)
library(jose)
library(withr)
library(here)
library(callr)
devtools::load_all()
Sys.setenv(JWT_SECRET = "test-secret")
secret_key <- Sys.getenv("JWT_SECRET")
#tmp_dir <- local_tempdir()
tmp_dir <- tempfile("test-account-base-")
dir.create(tmp_dir, recursive = TRUE)
Sys.setenv(ACCOUNT_BASE_DIR = tmp_dir)
# Create test user
create_user_account_base(
user_id = "user123",
base_dir = tmp_dir,
initial_balance = 1000
)
uuid <- load_user_account("user123")$uuid
# âœ… Server wait helper
wait_for_server_ready <- function(
url = "http://127.0.0.1:8000/__ping__",
timeout = 10
) {
start_time <- Sys.time()
while (as.numeric(Sys.time() - start_time, units = "secs") < timeout) {
res <- tryCatch(httr::GET(url), error = function(e) NULL)
if (!is.null(res) && httr::status_code(res) == 200) return(TRUE)
Sys.sleep(0.25)
}
stop("Server did not become ready within timeout.")
}
# ðŸ”§ Run main.R via callr
server <- callr::r_bg(
function(main_file, jwt, base_dir) {
Sys.setenv(JWT_SECRET = jwt)
Sys.setenv(ACCOUNT_BASE_DIR = base_dir)
source(main_file)
},
args = list(
main_file = here("api", "main.R"),
jwt = secret_key,
base_dir = tmp_dir
),
stdout = "|", stderr = "|"
)
withr::defer(server$kill(), envir = globalenv())
wait_for_server_ready()
cat("Server output:\n")
cat(server$read_output_lines(), sep = "\n")
cat("Server errors:\n")
cat(server$read_error_lines(), sep = "\n")
# ðŸª™ Make the deposit
valid_token <- jwt_encode_hmac(
jwt_claim(user_id = "user123", role = "user"),
secret = secret_key
)
res <- POST(
url = "http://127.0.0.1:8000/deposit",
add_headers(Authorization = paste("Bearer", valid_token)),
body = list(
uuid = uuid,
amount = 1000,
channel = "bank"
),
encode = "form"
)
cat("Status Code:", status_code(res), "\n")
print(content(res))
print(list.files(tmp_dir, recursive = TRUE))
library(testthat)
library(httr)
library(jose)
library(withr)
library(here)
library(callr)
devtools::load_all()
Sys.setenv(JWT_SECRET = "test-secret")
secret_key <- Sys.getenv("JWT_SECRET")
#tmp_dir <- local_tempdir()
tmp_dir <- tempfile("test-account-base-")
dir.create(tmp_dir, recursive = TRUE)
Sys.setenv(ACCOUNT_BASE_DIR = tmp_dir)
# Create test user
create_user_account_base(
user_id = "user123",
base_dir = tmp_dir,
initial_balance = 1000
)
uuid <- load_user_account("user123")$uuid
# âœ… Server wait helper
wait_for_server_ready <- function(
url = "http://127.0.0.1:8000/__ping__",
timeout = 10
) {
start_time <- Sys.time()
while (as.numeric(Sys.time() - start_time, units = "secs") < timeout) {
res <- tryCatch(httr::GET(url), error = function(e) NULL)
if (!is.null(res) && httr::status_code(res) == 200) return(TRUE)
Sys.sleep(0.25)
}
stop("Server did not become ready within timeout.")
}
library(testthat)
library(httr)
library(jose)
library(withr)
library(here)
library(callr)
devtools::load_all()
Sys.setenv(JWT_SECRET = "test-secret")
secret_key <- Sys.getenv("JWT_SECRET")
#tmp_dir <- local_tempdir()
tmp_dir <- tempfile("test-account-base-")
dir.create(tmp_dir, recursive = TRUE)
Sys.setenv(ACCOUNT_BASE_DIR = tmp_dir)
# Create test user
create_user_account_base(
user_id = "user123",
base_dir = tmp_dir,
initial_balance = 1000
)
uuid <- load_user_account("user123")$uuid
# âœ… Server wait helper
wait_for_server_ready <- function(
url = "http://127.0.0.1:8000/__ping__",
timeout = 10
) {
start_time <- Sys.time()
while (as.numeric(Sys.time() - start_time, units = "secs") < timeout) {
res <- tryCatch(httr::GET(url), error = function(e) NULL)
if (!is.null(res) && httr::status_code(res) == 200) return(TRUE)
Sys.sleep(0.25)
}
stop("Server did not become ready within timeout.")
}
# ðŸ”§ Run main.R via callr
server <- callr::r_bg(
function(main_file, jwt, base_dir) {
Sys.setenv(JWT_SECRET = jwt)
Sys.setenv(ACCOUNT_BASE_DIR = base_dir)
source(main_file)
},
args = list(
main_file = here("api", "main.R"),
jwt = secret_key,
base_dir = tmp_dir
),
stdout = "|", stderr = "|"
)
withr::defer(server$kill(), envir = globalenv())
wait_for_server_ready()
cat("Server output:\n")
cat(server$read_output_lines(), sep = "\n")
cat("Server errors:\n")
cat(server$read_error_lines(), sep = "\n")
# ðŸª™ Make the deposit
valid_token <- jwt_encode_hmac(
jwt_claim(user_id = "user123", role = "user"),
secret = secret_key
)
res <- POST(
url = "http://127.0.0.1:8000/deposit",
add_headers(Authorization = paste("Bearer", valid_token)),
body = list(
uuid = uuid,
amount = 1000,
channel = "bank"
),
encode = "form"
)
cat("Status Code:", status_code(res), "\n")
print(content(res))
cat("Server output:\n")
cat(server$read_output_lines(), sep = "\n")
cat("Server errors:\n")
cat(server$read_error_lines(), sep = "\n")
library(testthat)
library(httr)
library(jose)
library(withr)
library(here)
library(callr)
devtools::load_all()
Sys.setenv(JWT_SECRET = "test-secret")
secret_key <- Sys.getenv("JWT_SECRET")
#tmp_dir <- local_tempdir()
tmp_dir <- tempfile("test-account-base-")
dir.create(tmp_dir, recursive = TRUE)
Sys.setenv(ACCOUNT_BASE_DIR = tmp_dir)
# Create test user
create_user_account_base(
user_id = "user123",
base_dir = tmp_dir,
initial_balance = 1000
)
uuid <- load_user_account("user123")$uuid
# âœ… Server wait helper
wait_for_server_ready <- function(
url = "http://127.0.0.1:8000/__ping__",
timeout = 10
) {
start_time <- Sys.time()
while (as.numeric(Sys.time() - start_time, units = "secs") < timeout) {
res <- tryCatch(httr::GET(url), error = function(e) NULL)
if (!is.null(res) && httr::status_code(res) == 200) return(TRUE)
Sys.sleep(0.25)
}
stop("Server did not become ready within timeout.")
}
# ðŸ”§ Run main.R via callr
server <- callr::r_bg(
function(main_file, jwt, base_dir) {
Sys.setenv(JWT_SECRET = jwt)
Sys.setenv(ACCOUNT_BASE_DIR = base_dir)
source(main_file)
},
args = list(
main_file = here("api", "main.R"),
jwt = secret_key,
base_dir = tmp_dir
),
stdout = "|", stderr = "|"
)
withr::defer(server$kill(), envir = globalenv())
wait_for_server_ready()
cat("Server output:\n")
cat(server$read_output_lines(), sep = "\n")
cat("Server errors:\n")
cat(server$read_error_lines(), sep = "\n")
# ðŸª™ Make the deposit
valid_token <- jwt_encode_hmac(
jwt_claim(user_id = "user123", role = "user"),
secret = secret_key
)
res <- POST(
url = "http://127.0.0.1:8000/deposit",
add_headers(Authorization = paste("Bearer", valid_token)),
body = list(
uuid = uuid,
amount = 1000,
channel = "bank"
),
encode = "form"
)
cat("Status Code:", status_code(res), "\n")
print(content(res))
library(testthat)
library(httr)
library(jose)
library(withr)
library(here)
library(callr)
devtools::load_all()
Sys.setenv(JWT_SECRET = "test-secret")
secret_key <- Sys.getenv("JWT_SECRET")
#tmp_dir <- local_tempdir()
tmp_dir <- tempfile("test-account-base-")
dir.create(tmp_dir, recursive = TRUE)
Sys.setenv(ACCOUNT_BASE_DIR = tmp_dir)
# Create test user
create_user_account_base(
user_id = "user123",
base_dir = tmp_dir,
initial_balance = 1000
)
uuid <- load_user_account("user123")$uuid
# âœ… Server wait helper
wait_for_server_ready <- function(
url = "http://127.0.0.1:8000/__ping__",
timeout = 10
) {
start_time <- Sys.time()
while (as.numeric(Sys.time() - start_time, units = "secs") < timeout) {
res <- tryCatch(httr::GET(url), error = function(e) NULL)
if (!is.null(res) && httr::status_code(res) == 200) return(TRUE)
Sys.sleep(0.25)
}
stop("Server did not become ready within timeout.")
}
# ðŸ”§ Run main.R via callr
server <- callr::r_bg(
function(main_file, jwt, base_dir) {
Sys.setenv(JWT_SECRET = jwt)
Sys.setenv(ACCOUNT_BASE_DIR = base_dir)
source(main_file)
},
args = list(
main_file = here("api", "main.R"),
jwt = secret_key,
base_dir = tmp_dir
),
stdout = "|", stderr = "|"
)
withr::defer(server$kill(), envir = globalenv())
wait_for_server_ready()
cat("Server output:\n")
cat(server$read_output_lines(), sep = "\n")
cat("Server errors:\n")
cat(server$read_error_lines(), sep = "\n")
# ðŸª™ Make the deposit
valid_token <- jwt_encode_hmac(
jwt_claim(user_id = "user123", role = "user"),
secret = secret_key
)
res <- POST(
url = "http://127.0.0.1:8000/deposit",
add_headers(Authorization = paste("Bearer", valid_token)),
body = list(
uuid = uuid,
amount = 1000,
channel = "bank"
),
encode = "form"
)
cat("Status Code:", status_code(res), "\n")
print(content(res))
cat("Server output:\n")
cat(server$read_output_lines(), sep = "\n")
cat("Server errors:\n")
cat(server$read_error_lines(), sep = "\n")
library(testthat)
library(httr)
library(jose)
library(withr)
library(here)
library(callr)
devtools::load_all()
Sys.setenv(JWT_SECRET = "test-secret")
secret_key <- Sys.getenv("JWT_SECRET")
#tmp_dir <- local_tempdir()
tmp_dir <- tempfile("test-account-base-")
dir.create(tmp_dir, recursive = TRUE)
Sys.setenv(ACCOUNT_BASE_DIR = tmp_dir)
# Create test user
create_user_account_base(
user_id = "user123",
base_dir = tmp_dir,
initial_balance = 1000
)
uuid <- load_user_account("user123")$uuid
# âœ… Server wait helper
wait_for_server_ready <- function(
url = "http://127.0.0.1:8000/__ping__",
timeout = 10
) {
start_time <- Sys.time()
while (as.numeric(Sys.time() - start_time, units = "secs") < timeout) {
res <- tryCatch(httr::GET(url), error = function(e) NULL)
if (!is.null(res) && httr::status_code(res) == 200) return(TRUE)
Sys.sleep(0.25)
}
stop("Server did not become ready within timeout.")
}
# ðŸ”§ Run main.R via callr
server <- callr::r_bg(
function(main_file, jwt, base_dir) {
Sys.setenv(JWT_SECRET = jwt)
Sys.setenv(ACCOUNT_BASE_DIR = base_dir)
source(main_file)
},
args = list(
main_file = here("api", "main.R"),
jwt = secret_key,
base_dir = tmp_dir
),
stdout = "|", stderr = "|"
)
withr::defer(server$kill(), envir = globalenv())
wait_for_server_ready()
cat("Server output:\n")
cat(server$read_output_lines(), sep = "\n")
cat("Server errors:\n")
cat(server$read_error_lines(), sep = "\n")
# ðŸª™ Make the deposit
valid_token <- jwt_encode_hmac(
jwt_claim(user_id = "user123", role = "user"),
secret = secret_key
)
res <- POST(
url = "http://127.0.0.1:8000/deposit",
add_headers(Authorization = paste("Bearer", valid_token)),
body = list(
uuid = uuid,
amount = 1000,
channel = "bank"
),
encode = "form"
)
cat("Status Code:", status_code(res), "\n")
print(content(res))
devtools::test_active_file()
devtools::test_active_file()
devtools::test_active_file()
devtools::test_active_file()
devtools::test_active_file()
devtools::test_active_file()
testthat::test_file("api/tests/test_endpoints.R")
testthat::test_file("api/tests/test_endpoints.R")
testthat::test_file("api/tests/test_endpoints.R")
